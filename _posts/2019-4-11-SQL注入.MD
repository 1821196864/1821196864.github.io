---
layout:     post
title:      SQL注入
subtitle:   SQL注入小结
date:       2019-4-11
author:     k
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Blog
---



SQL注入

原理:

漏洞形成原因：
  
    （1）有一个参数用户可控；
    
    （2）服务器对该参数没有过滤或者过滤不严谨。
    
漏洞本质：
  
     将用户提交的数据当做代码执行，违背了“数据和代码分离”原则
     
sql注入分类

    请求方式： GET方式 POST方式
    
        根据sql注入点的参数类型分类（数据类型）：整数型注入 字符型注入 搜索型注入
        根据sql注入点的反馈类型：报错注入 联合注入 布尔注入 时间注入
        根据数据库类型：MSSQL MYSQL ORACLE ACCESS NOSQL等

一:盲注：

    用户提交的数据在后台数据库中执行，没有任何的数据（报错信息、执行sql的数据）传递到到前端，这种类型就是盲注
    
   分类:
    
       基于布尔的盲注 基于时间的盲注

二：报错注入

    利用前提: 页面上没有显示位，但是需要输出 SQL 语句执行错误信息。比如 mysql_error()
    优点: 不需要显示位
    缺点: 需要输出 mysql_error( )的报错信息

 1.floor报错注入

    floor报错注入是利用 count()函数 、rand()函数 、floor()函数 、group by 这几个特定的函数结合在一起产生的注入漏洞。缺一不可

 2.ExtractValue报错注入

    EXTRACTVALUE (XML_document, XPath_string)
    第一个参数：XML_document 是 String 格式，为 XML 文档对象的名称，文中为 Doc
    第二个参数：XPath_string (Xpath 格式的字符串).
    作用：从目标 XML 中返回包含所查询值的字符
    ps: 返回结果 限制在32位字符
    
 3.UpdateXml报错注入
 
      UPDATEXML (XML_document, XPath_string, new_value)
      第一个参数：XML_document 是 String 格式，为 XML 文档对象的名称，文中为 Doc 1
      第二个参数：XPath_string (Xpath 格式的字符串) ，如果不了解 Xpath 语法，可以在网上查找教程。
      第三个参数：new_value，String 格式，替换查找到的符合条件的数据
      作用：改变文档中符合条件的节点的值
   
   
三：sleep延时注入


     利用前提：页面上没有显示位，也没有输出 SQL 语句执行错误信息。正确的 SQL 语句和错误的 SQL 语句返回页面都一样，但是加入 sleep(5)条件之后，页面的返回速度明显慢了 5 秒。
     优点: 不需要显示位，不需要出错信息。
     缺点: 速度慢，耗费大量时间
     sleep函数判断页面响应时间 
     if(判断条件，为true时执行，为false时执行)
     我们可以构造下面的语句，判断条件是否成立。              然后不断变换函数直到获取到我们想要的信息
     
     // 判断数据库的第一个字符的ascii值是否大于100，如果大于100，页面立即响应，如果不大于，页面延时5秒响应
     http://127.0.0.1/sqli/Less-1/?id=1' and if(ascii(substring(database(),1,1))<100,1,sleep(5)) #

四：宽字节注入

    宽字节注入是由于不同编码中中英文所占字符的不同所导致的。通常来说，在GBK编码当中，一个汉字占用2个字节。而在UTF-8编码中，一个汉字占用3个字节。在php中，我们可以通过输入 echo strlen("中") 来测试，
    当为GBK编码时，输入2，而为UTF-8编码时，输出3。除了GBK以外，所有的ANSI编码都是中文都是占用两个字节
    
    addslashes()函数，这个函数在预定义字符之前添加反斜杠 \ 。预定义字符：  单引号 ' 、双引号 " 、反斜杠 \ 、NULL。但是这个函数有一个特点就是虽然会添加反斜杠 \ 进行转义，但是 \ 并不会插入到数据库中。
    这个函数的功能和魔术引号完全相同，所以当打开了魔术引号时，不应使用这个函数。可以使用 get_magic_quotes_gpc() 来检测是否已经转义。
    
    mysql_real_escape_string() 函数，这个函数用来转义sql语句中的特殊符号x00 、\n  、\r  、\  、‘  、“ 、x1a。

    ps:魔术引号：当打开时，所有的单引号’、双引号"、反斜杠\ 和 NULL 字符都会被自动加上一个反斜线来进行转义，这个和 addslashes()函数的作用完全相同。所以，如果魔术引号打开了，就不要使用addslashes()函数了。一共有三个魔术引号指令。
   
   
五：二次注入

    二次注入漏洞是一种在Web应用程序中广泛存在的安全漏洞形式。相对于一次注入漏洞而言，二次注入漏洞更难以被发现，但是它却具有与一次注入攻击漏洞相同的攻击威力。
    
    1.黑客通过构造数据的形式，在浏览器或者其他软件中提交HTTP数据报文请求到服务端进行处理，提交的数据报文请求中可能包含了黑客构造的SQL语句或者命令。
   
    2.服务端应用程序会将黑客提交的数据信息进行存储，通常是保存在数据库中，保存的数据信息的主要作用是为应用程序执行其他功能提供原始输入数据并对客户端请求做出响应。
   
    3.黑客向服务端发送第二个与第一次不相同的请求数据信息。
    
    4.服务端接收到黑客提交的第二个请求信息后，为了处理该请求，服务端会查询数据库中已经存储的数据信息并处理，从而导致黑客在第一次请求中构造的SQL语句或者命令在服务端环境中执行。
    
    5.服务端返回执行的处理结果数据信息，黑客可以通过返回的结果数据信息判断二次注入漏洞利用是否成功.
    
    
六：传说中的万能密码 

     sql="select*from test where username=' XX '  and password=' XX '  ";

      admin' or '1'='1  XX   //万能密码(已知用户名)
      XX   'or'1'='1        //万能密码(不需要知道用户名)
     'or'1'='1'#     XX    //万能密码(不知道用户名)


